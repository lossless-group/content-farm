import { App, MarkdownView, Modal, Notice, Plugin, PluginSettingTab, Setting, TFile, Editor } from 'obsidian';
import * as crypto from 'crypto';
import { MCPClient } from './src/mcp/client';
import { streamToEditor } from './src/utils/streaming';

interface ContentFarmSettings {
    mySetting: string;
    localLLMPath: string;
    mcpServerUrl: string;
    autoEnhanceOnOpen: boolean;
    requestBodyTemplate: string;
    enhanceBodyTemplate: string;
}

const DEFAULT_SETTINGS: ContentFarmSettings = {
    mySetting: 'default',
    localLLMPath: 'http://localhost:3030/api/search',
    mcpServerUrl: 'http://localhost:4444',
    autoEnhanceOnOpen: false,
    requestBodyTemplate: JSON.stringify({
        chatModel: {
            provider: 'ollama',
            name: 'llama3.2:latest'
        },
        embeddingModel: {
            provider: 'ollama',
            name: 'llama3.2:latest'
        },
        optimizationMode: 'speed',
        focusMode: 'webSearch',
        query: 'What is Perplexicas architecture',
        history: [
            ['human', 'Hi, how are you?'],
            ['assistant', 'I am doing well, how can I help you today?']
        ],
        systemInstructions: 'Focus on providing technical details about Perplexicas architecture.',
        stream: false
    }),
    enhanceBodyTemplate: JSON.stringify({
        chatModel: {
            provider: 'ollama',
            name: 'llama3.2:latest'
        },
        embeddingModel: {
            provider: 'ollama',
            name: 'llama3.2:latest'
        },
        optimizationMode: 'speed',
        focusMode: 'webSearch',
        query: 'The content of the markdown file is not as robust, and the citations are not as rigorous as we would like them to be. Please enhance the content with more research and citations, focusing on recent sources with links',
        history: [
            ['human', 'Hi, how are you?'],
            ['assistant', 'I am doing well, how can I help you today?']
        ],
        systemInstructions: 'Focus on authoritative sources, or recognizable or reputable sources. Output content in Markdown with good structure.',
        stream: false
    })
};
